<app-phunk-billboard [phunk]="(singlePhunk$ | async)" />

<div class="view-item-wrapper">
  <app-breadcrumbs [phunk]="(singlePhunk$ | async)" />

  <div class="inner">
    @if ((singlePhunk$ | async); as phunk) {
    <div class="details-wrapper">

      <div class="title-wrapper">
        <h1 i18n>EtherPhunk {{ phunk.phunkId }}</h1>
        <div class="hash-id">
          {{ phunk.hashId }}
          <!-- <app-wallet-address [address]="phunk.hashId"></app-wallet-address> -->
        </div>
        @if (phunk.attributes) {
        <h2 i18n>One of {{ phunk.attributes[0].v | traitCount }}
          <a class="highlight" [routerLink]="['/', 'all']" [queryParams]="getItemQueryParams(phunk.attributes[0])">

            {{ phunk.attributes[0].v }}
          </a> EtherPhunks.
        </h2>
        }
      </div>

      <div class="split">

        <div class="left">
          <div class="market-status">
            <h2 i18n>Market Status</h2>

            @if (phunk.isEscrowed) {
              <!-- Owner -->
              @if (phunk.prevOwner; as owner) {
                <p i18n>This EtherPhunk is held in <a [routerLink]="['/', 'owned']" [queryParams]="{ address: escrowAddress }">escrow</a> for <a [routerLink]="['/', 'owned']" [queryParams]="{ address: owner }"><app-wallet-address [address]="owner"></app-wallet-address></a>.</p>
              }
            } @else {
              <!-- Owner -->
              @if (phunk.owner; as owner) {
                <p i18n>This EtherPhunk is owned by <a [routerLink]="['/', 'owned']" [queryParams]="{ address: owner }"><app-wallet-address [address]="owner"></app-wallet-address></a>.</p>
              }
            }

            <!-- Value (Listing) -->
            @if (phunk.listing?.minValue; as value) {
              <p i18n>This EtherPhunk is for sale for <span class="highlight">{{ (value | weiToEth) | formatCash }} ETH</span><span class="bold"> (${{ ((value | weiToEth) * ((dataSvc.usd$ | async) || 0)) | formatCash }})</span>.</p>
            } @else {
              <p i18n>This EtherPhunk is not for sale.</p>
            }

            <!-- Has bid -->
            @if (phunk.bid; as bid) {
              @if (bid.value && bid.fromAddress) {
                <p i18n>There is a bid of <span class="bold">{{ bid.value | weiToEth }} ETH</span> ({{ ((bid.value | weiToEth) * ((dataSvc.usd$ | async) || 0)) | currency }}) for this EtherPhunk from <a [routerLink]="['/', 'owned']" [queryParams]="{ address: bid.fromAddress }"><app-wallet-address [address]="bid.fromAddress"></app-wallet-address></a>.</p>
              }
            } @else {
              <p i18n>There are no bids on this EtherPhunk.</p>
            }
          </div>

          <div class="actions-wrapper" [class.cooldown]="isCooling$ | async" [class.pending]="hasPendingTx$ | async">

            @if ((walletAddress$ | async); as address) {
              @if (phunk.owner; as owner) {
                <!-- Buy button -->
                @if (
                  phunk.listing &&
                  phunk.isEscrowed &&
                  (phunk.prevOwner | lowercase) !== (address | lowercase)
                ) {
                  <button i18n class="buy" (click)="buyPhunk(phunk)">
                    Buy
                  </button>
                }

                <!-- Sell (Ownership actions) -->
                @if (
                  ((owner | lowercase) === (escrowAddress | lowercase) &&
                  (phunk.prevOwner | lowercase) === (address | lowercase)) ||
                  (owner | lowercase) === (address | lowercase)
                ) {
                  <button i18n class="sell" (click)="sellPhunk()" [class.active]="sellActive">
                    Sell
                  </button>

                  <!-- Sell Actions -->
                  @if (sellActive) {
                    @if (phunk.isEscrowed) {
                      <ng-container *ngTemplateOutlet="sellForm; context:{ $implicit: phunk }" />
                    } @else {
                      <div class="form-wrapper">
                        @if (isCooling$ | async) {
                          <ng-template [ngTemplateOutlet]="cooldown" />
                        }
                        <p i18n>Your EtherPhunk must be held in escrow in order to be listed. <span class="small">While held in escrow, your Phunk will not show in your wallet on other apps/marketplaces.</span></p>
                        <button i18n class="sell" (click)="sendToEscrow(phunk)">
                          Send to Escrow
                        </button>
                      </div>
                    }
                  }

                  @if (phunk.isEscrowed) {
                    <button i18n class="withdraw" (click)="withdrawPhunk(phunk)">
                      Withdraw from escrow
                    </button>
                  }
                }

                <!-- Transfer -->
                @if ((owner | lowercase) === (address | lowercase)) {
                  <button i18n class="transfer" [class.active]="transferActive" (click)="transferPhunkAction()">
                    Transfer
                  </button>

                  <button (click)="sendToAuction(phunk.hashId)">Send to Auction</button>

                  <!-- Transfer Actions -->
                  @if (transferActive) {
                    <ng-container *ngTemplateOutlet="transferForm; context:{ $implicit: phunk }" />
                  }
                }

                <!-- Delist button -->
                @if (
                  phunk.listing &&
                  (owner | lowercase) === (escrowAddress | lowercase) &&
                  (phunk.prevOwner | lowercase) === (address | lowercase)
                ) {
                  <button i18n class="sell" (click)="phunkNoLongerForSale(phunk)">
                    Delist
                  </button>
                }

                <!-- Bid -->
                @if (
                  (owner | lowercase) !== (address | lowercase) &&
                  (phunk.prevOwner | lowercase) !== (address | lowercase)
                ) {
                  <button i18n [class.active]="bidActive" class="sell" (click)="bidOnPhunk()">
                    Place Bid
                  </button>

                  <!-- Bid Actions -->
                  @if (bidActive) {
                    <ng-container *ngTemplateOutlet="bidForm; context:{ $implicit: phunk }" />
                  }
                }

                <!-- Withdraw Bid button -->
                @if (((phunk.bid?.fromAddress | lowercase) === (address | lowercase))) {
                  <button i18n class="sell" (click)="withdrawBidForPhunk(phunk)">
                    Withdraw Bid
                  </button>
                }

                <!-- Accept Bid button -->
                @if (
                  phunk.bid &&
                  ((owner | lowercase) === (escrowAddress | lowercase)) &&
                  (phunk.prevOwner | lowercase) === (address | lowercase)
                ) {
                  <button i18n class="sell" (click)="acceptBidForPhunk(phunk)">
                    Accept Top Bid
                  </button>
                }
              }

            } @else {
              <button i18n (click)="web3Svc.connect()">Connect an Ethereum wallet to interact with this item</button>
            }

          </div>
        </div>

        <div class="right">
          <div class="accessories-wrapper">
            <h2 i18n>Attributes</h2>
            @if (phunk.attributes?.length) {
              <div class="accessories">
                @for (item of phunk.attributes; track item; let i = $index) {
                  @if (i > 1) {
                  <div class="accessory">
                    <a class="value" [routerLink]="['/', 'all']" [queryParams]="getItemQueryParams(item)">
                      {{ item.v }}
                      <span>{{ (+(item.v | traitCount) / 10000) | percent : '1.1-1' }}</span>
                    </a>
                    <span class="trait-count">
                      <span>{{ item.v | traitCount }}</span>
                      EtherPhunks have this.
                    </span>
                  </div>
                  }
                }
              </div>
            }
          </div>
        </div>
      </div>

      <app-tx-history [hashId]="phunk.hashId"></app-tx-history>
    </div>
    } @else {
      <div class="details-wrapper">

        <div class="title-wrapper">
          <div class="title-color">
            <h1 i18n>EtherPhunk Loading...</h1>
          </div>
          <h2 i18n>&nbsp;</h2>
        </div>

        <div class="accessories-wrapper">
          <h2 i18n>Attributes</h2>
          <div class="accessories">
            @for (item of [0, 1, 2]; track item) {
              <div class="accessory">
                <span class="value"></span>
                <span class="trait-count"></span>
              </div>
            }
          </div>
        </div>
      </div>
    }
  </div>
</div>

<!-- Transfer Form -->
<ng-template #transferForm let-phunk>
  <form class="form-wrapper">
    @if (isCooling$ | async) { <ng-template [ngTemplateOutlet]="cooldown" /> }
    <div class="form-group">
      <label i18n for="transfer-address">Transfer to address</label>
      <input #transferAddressInput type="text" id="transfer-address" [formControl]="transferAddress"
        placeholder="0x or .ens" role="presentation" autocomplete="off" />
    </div>

    <div class="form-actions">
      <button i18n type="reset" class="cancel" (click)="closeTransfer()">Cancel</button>
      <button i18n type="submit" class="submit" (click)="transferPhunk(phunk)">Submit</button>
    </div>
  </form>
</ng-template>

<!-- Bid Form -->
<ng-template #bidForm let-phunk>
  <form class="form-wrapper">
    <!-- @if (isCooling$ | async) { <ng-template [ngTemplateOutlet]="cooldown" /> } -->
    <div class="form-group">
      <label i18n for="bid-price">Bid Price (Ξ)</label>
      <input #bidPriceInput type="number" id="bid-price" [formControl]="bidPrice" placeholder="0" />
    </div>

    <div class="form-actions">
      <button i18n type="reset" class="cancel" (click)="closeBid()">Cancel</button>
      <button i18n type="submit" class="submit" (click)="submitBid(phunk)">Submit</button>
    </div>
  </form>
</ng-template>

<!-- Sell Form -->
<ng-template #sellForm let-phunk>
  <form class="form-wrapper">
    <!-- @if (isCooling$ | async) { <ng-template [ngTemplateOutlet]="cooldown" /> } -->
    <div class="form-group">
      <label i18n for="list-price">Asking Price in ETH (Ξ)</label>
      <input #sellPriceInput type="number" id="list-price" [min]="0" [formControl]="listPrice" />
    </div>

    <div class="form-group" [class.disabled]="!phunk.isEscrowed">
      <label i18n for="list-to-address">Offer to Address (0x or ens)</label>
      <input type="text" id="list-to-address" [placeholder]="'Anyone'" [formControl]="listToAddress" role="presentation"
        autocomplete="off" />
    </div>

    <div class="form-actions" [class.disabled]="!phunk.isEscrowed">
      <button i18n type="reset" class="cancel" (click)="closeListing()">Cancel</button>
      <button i18n type="submit" class="submit" (click)="submitListing(phunk)">Offer EtherPhunk</button>
    </div>
  </form>
</ng-template>


<ng-template #cooldown>
  <div class="cooldown-wrapper">
    <p>6 Block cooldown period</p>
    <img src="/assets/loader-phunk.gif" width="30" height="30" alt="">
  </div>
</ng-template>
